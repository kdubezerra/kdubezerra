%Quebrar em dois capitulos, se necessário.
\chapter {Considerações Finais e Trabalhos Futuros}

%por TUDO do plano de doutorado!!!

Como parte do mestrado, definiu-se um modelo preliminar, que visa justamente ao particionamento do ambiente virtual em regiões, cada uma atribuída a um servidor, sobre o qual foi definido um esquema de balanceamento de carga. O Cosmmus -- \emph{Cooperative System for Massive Multiplayer Service} -- será um novo modelo, a ser definido durante o doutorado, que também utilizará o princípio usado no mestrado de distribuição do jogo através de particionamento do ambiente virtual em regiões, porém atacando problemas mais críticos, que foram deixados de lado até então.

O Cosmmus deverá incluir soluções para os principais aspectos relacionados a MMOGs, como distribuição de tarefas, sincronização da simulação, persistência distribuída e assim por diante. Embora este modelo não esteja definido ainda, já há algumas idéias de como ele poderá ser e que tipo de abordagens ele deve utilizar, baseado em pesquisa relacionada. Nas seções seguintes, serão apresentadas estas idéias iniciais, que virão a ser melhor desenvolvidas durante o curso de doutorado.
% Como os jogadores interagem!!!

\section{Distribuição da carga do jogo}

Já foram feitos alguns trabalhos relacionados ao particionamento do ambiente virtual do jogo \cite{devleeschauwer2005dma, morillo2006spp, lui2002epa}. Para o Cosmmus, pensa-se em fazer a distribuição da carga do jogo entre os nodos servidores em dois níveis:

\begin{enumerate}
	\item Assim como no mestrado, será utilizada a idéia de células de mesmo tamanho e posição fixa, que são áreas do ambiente. Essas células então serão agrupadas em regiões, cujo tamanho e formato irão depender da maneira como os avatares dos jogadores estão mais ou menos concentrados em determinados lugares. Isto deverá ser feito de maneira transparente para o jogador, que verá um mundo grande e contíguo através do qual poderá mover-se livremente;	
	\item Cada região poderá ser designada a mais de um nodo servidor, com dois objetivos principais: primeiramente, prover tolerância a falhas por meio de replicação e, em segundo lugar, permitir que regiões que já estão muito sobrecarregadas sejam gerenciadas por mais de um nodo servidor.	
\end{enumerate}

No caso de uma região estar muito sobrecarregada, poderia-se pensar em fazer um novo particionamento, em duas ou mais novas regiões, mas isto poderia ser contraproducente em determinadas situações, como no caso em que a região engloba um hotspot e sua divisão resultaria em duas regiões excessivamente dependentes entre si. Para isso deverá ser criado também um algoritmo, métrica ou heurística que determine se uma região deve ou não ser subdividida em novas regiões.

Foi proposto durante o mestrado um esquema de balanceamento de carga dinâmico, baseado em particionamento de grafo e refinamento de suas partições \cite{kernighan1970ehp, karypis1999pmk, karypis1998mam, dutt1993nfk}. O mundo é dividido em células de mesmo tamanho e posição fixa, cada uma representada por um vértice em um grafo. A interação (medida em kilobytes por segundo) entre as células são representadas pelas arestas dos vértices. O algoritmo consiste no particionamento do grafo, sendo que cada partição representa uma região a ser atribuída a um servidor. Tal balanceamento leva em conta diferentes níveis de recursos entre os diferentes servidores e leva em conta as necessidades dos MMOGs, que se concentram com maior peso no uso de largura de banda dos servidores.

Também seria necessário um esquema de balanceamento de carga, que, pretende-se, seguirá o mesmo princípio do esquema proposto no mestrado. A questão é que, diferente do modelo do mestrado, não haverá mais apenas um nodo servidor por região, mas um grupo de nodos servidores. Neste caso, serão investigadas maneiras de balancear a carga do sistema, considerando essa distribuição em dois níveis. Uma idéia seria a de usar apenas réplicas, com o intuito de prover tolerância a falhas na região. A carga dentro de uma região seria redistribuída apenas quando a mesma estivesse sobrecarregada e não fosse viável reparticioná-la.

\section{Formação da rede lógica do sistema servidor}

Quanto à formação da rede overlay sobre a qual será executado o sistema servidor, existem propostas, como em \cite{ta2008nas, ratnasamy2002tao, han2005tao, zhang2004cla}, que buscam montar a rede de forma que nodos com boa conexão de rede entre si estejam adjacentes na rede lógica. Foi proposto, por exemplo, agrupar os nodos de acordo com o atraso de rede entre eles. Pretende-se utilizar estas técnicas de maneira que certos nodos servidores servindo regiões adjacentes e, principalmente, nodos que estejam servindo à mesma região, pertençam ao mesmo grupo. Pode-se também adaptá-las, incluindo outros critérios além do atraso, como a velocidade da transmissão de dados entre eles, em bits por segundo.

O propósito de montar a rede overlay seguindo essa estratégia seria o de minimizar o atraso na interação entre jogadores. Essa atraso na interação seria o tempo decorrido desde o envio de uma ação de um jogador, processamento pelo servidor e recebimento do estado resultante por outro jogador. Se dois jogadores quaisquer estiverem interagindo um com o outro, porém conectados a nodos servidores diferentes, será necessário que cada uma de suas interações seja intermediada pelos dois servidores. Assim, se estes dois servidores tiverem baixo atraso entre eles, a interação dos jogadores será menos prejudicada pelo acréscimo de um segundo servidor intermediário.

\section{Sincronização de estado}

Uma das questões centrais que o Cosmmus deverá tratar é a da manutenção da consistência da simulação entre os diferentes nodos servidores. Ainda que cada jogador veja apenas uma parte do mundo virtual, este mundo deve ser o mesmo para todos os servidores. Assim, se dois jogadores estão com seus avatares no mesmo lugar do ambiente virtual, eles deverão visualizar o mesmo ambiente. Outra questão importante é a ordenação dos eventos. Supondo que dois jogadores estivessem lutando no jogo, e o avatar de um deles atirasse com uma arma qualquer e o outro se movesse, a ordem desses eventos seria crucial para decidir se o outro jogador teve seu avatar morto, apenas ferido ou se evitou completamente o disparo.

No caso em que os dois jogadores estivessem conectados ao mesmo servidor, como é tradicionalmente feito por empresas de jogos, isto seria trivial, bastando verificar qual das ações chegou primeiro. Ainda que se utilizasse um mecanismo de compensação de atraso -- o \emph{timestamp} da ação de cada jogador seria igual ao tempo atual menos o seu atraso --, como é feito em Half-Life \cite{halflife}, por exemplo, não seria muito problemático ordenar estes eventos. No caso de um servidor distribuído, seria necessário que os nodos servidores entrassem em algum tipo de acordo ou sincronia no que diz respeito a essa ordenação, cuja complexidade cresceria com o número de servidores envolvidos.

Levando em conta que há várias regiões formando um mundo contíguo, e que em cada uma existe um ou mais servidores, estas questões referentes a manter a consistência da simulação se tornam ainda mais difíceis quando um avatar se aproxima de uma fronteira da região onde está localizado. Espera-se que a divisão do ambiente não seja percebida pelo jogador. Então, ao se aproximar de uma fronteira, ele deverá ser capaz de ver tudo que estiver além dela e de mover-se livremente de uma para outra. Para isto, será necessário que o servidor ao qual ele está conectado comunique-se com aquele que serve a região, além da fronteira, que está sendo visualizada pelo jogador. Serão transmitidas informações como: estado do ambiente, avatares que estejam próximos, estados desses avatares e assim por diante.

Em um trabalho do GPPD \cite{cecin2006pps}, foi proposto um esquema de sincronização de estado que consiste de dois simuladores: um conservador e um otimista. Enquanto que o otimista executa as ações dos jogadores assim que são recebidas e exibe imediatamente seu resultado na tela do jogador, o simulador conservador divide o tempo em turnos e somente executa as ações dos jogadores após haver uma sincronização. Esta sincronização consiste em que cada nodo executando a simulação receba as ações de todos os participantes envolvidos -- ou a notificação de que estes não fizeram nada --, que foram em seguida ordenadas e processadas. Somente após este passo é que o simulador conservador avança para o próximo turno. No caso da simulação otimista discrepar além do tolerável da simulação conservadora, esta sobrescreve o seu estado sobre a primeira, que continua a partir daí. No entanto, este esquema foi proposto para uma arquitetura completamente descentralizada, sendo necessário analizá-lo e fazer as adaptações necessárias para que possa ser utilizado em um sistema servidor distribuído em dois níveis, como se pretende para o Cosmmus. Existem também outros trabalhos que visam a manter consistente a simulação, como \cite{zhou2007cmh, moon2006emc, muller2006csm}, que serão também estudados e possivelmente alguns de seus princípios farão parte da solução para consistência a ser definida para o modelo final.

\section{Persistência distribuída}

No que tange ao armazenamento do estado do mundo virtual e dos jogadores, deverá haver uma maneira de fazer isto de maneira distribuída, já que não haverá um único servidor central. Poderia ser mais simples escolher um dos nodos servidores para guardar estas informações, no entanto isso poderia fazer com que o estado do jogo dependesse da disponibilidade e confiabilidade deste nodo escolhido e, ainda que estes dois requisitos fossem satisfeitos, este servidor poderia ser saturado pelo número de requisições, tornando mais lenta a recuperação dos estados nele armazenados.

O Cosmmus deverá então utilizar algum esquema de armazenamento distribuído, onde porções da informação de estado são armazenados em diferentes lugares. Além disso, deverá ser utilizada replicação para que o estado esteja disponível ainda que alguns nodos do sistema se desconectem inesperadamente. Redes lógicas baseadas em DHT, como Pastry \cite{rowstron2001psd}, Tapestry \cite{zhao2004trg}, Chord \cite{stoica2001csp} e Koorde \cite{kaashoek2003ksd}, parecem ser possíveis soluções para prover o tipo de armazenamento distribuído e redundante que se quer para o estado do jogo. Pretende-se, portanto, investigar o quanto essas redes são realmente adequadas para este fim. Existem simuladores, como por exemplo o OverSim \cite{baumgart2007ofo}, que permitem a simulação de redes overlay, tais como as que foram citadas, e através de simulação será avaliado o comportamento do sistema utilizando essas redes lógicas.

O que pode ocorrer é que seja excessivo o custo de manter uma rede como a Pastry sobre o sistema servidor, recuperando e armazenando os estados utilizando multicast no nível de aplicação e utilizando replicação, se somado ao próprio custo que os nodos servidores já enfrentarão para executar a simulação em si, recebendo ações dos jogadores e devolvendo-lhes a resposta. Para não sobrecarregar o sistema com o tráfego referente à persistência do estado do jogo, poderiam ser ajustados parâmetros, tais como freqüência de atualização e, no nível da aplicação, o nível de detalhamento do estado a ser persistido. Por exemplo, ao invés de armazenar a localização, direção e ação sendo executada por cada avatar em uma área do ambiente virtual, poderia ser armazenada apenas sua localização.

\section{Otimização do uso de largura de banda}

Pelo fato dos nodos servidores serem, idealmente, de baixo custo, é necessário economizar seus recursos tanto quanto for possível, mas sem prejudicar a qualidade do jogo. Por exemplo, podem ser feitas filtragens por interesse, onde a cada jogador só é enviado aquilo que ele pode visualizar, de forma a economizar tráfego tanto entre clientes e servidores, quanto entre os próprios servidores. Seguindo esse mesmo princípio, servidores de duas regiões diferentes podem ter uma versão antiga do estado um do outro, se não estiver havendo interação entre jogadores conectados a servidores diferentes. Dessa forma, estes servidores não precisarão atualizar-se um ao outro com tanta freqüência.

Periodicamente, ou no momento em que for necessário (e.g. dois jogadores de diferentes regiões interagindo próximo à fronteira), poderão ser trocados os estados das regiões. A granularidade dessa informação pode ser ainda mais fina, e cada servidor poderia enviar para o outro apenas os dados mais essenciais. Por exemplo, cada servidor enviaria ao outro apenas o estado do ambiente virtual próximo à fronteira entre as regiões, ao invés do estado da região inteira.

%TODO: refs.
Diversos propostas já foram realizados com o intuito de fazer filtragem por interesse \cite{bezerra2008a3, ahmed2008dai, morgan2005imm, minson2005aim}. Além de investigar qual a que melhor se aplica ao modelo proposto, e de verificar possíveis adaptações que sejam necessárias, outras maneiras de economizar os recursos do sistema servidor serão estudadas.
%dewan, eu, etc...

%TODO: mudar esse título de seção
%\section{Questões filosóficas}
%
%%A filosofia por trás do Cosmmus está na cooperação entre diversas pessoas e/ou instituições com o intuito de formar um sistema para servir um jogo online maciçamente multijogador, disponibilizando seus recursos para isso.
%Apesar de, geralmente, ser necessário uma infra-estrutura central poderosa e cara \cite{feng2007wnn}, um sistema que siga a proposta aqui apresentada permitiria que recursos de empresas menores e usuários domésticos (com o mínimo exigido de capacidade de processamento e largura de banda, o que irá depender do jogo específico) fossem utilizados para formar um sistema para servir um jogo online maciçamente multijogador com qualidade comparável à dos MMOGs mais populares.
%
%O Cosmmus tem como idéia fundamental formar um sistema servidor sobre uma rede par-a-par, ao invés de distribuir indiscriminadamente a simulação entre quaisquer jogadores, como são diversas propostas pesquisadas. Existindo essa separação, onde somente os servidores poderiam arbitrar sobre o jogo, poderiam ser formadas comunidades cujo único intuito seria o de manter jogos MMOGs funcionando, organizando quem seria autorizado a participar do sistema como um nodo servidor e assim por diante. Poderia haver um esquema semelhante ao utilizado em diversos projetos de software livre, na Wikipédia \cite{adler2007cdr} e outros, onde o indivíduo que teve a idéia inicial vai gradualmente delegando autoridade a membros da comunidade, de acordo com o quanto cada um colaborou, criando uma hierarquia, onde há diferentes níveis de permissão, mas todos participam em um esforço comum.
%
%Além dessa questão filosófica, para um servidor de MMOGs, que age como árbitro central e por onde toda a simulação tem que passar, é mais fácil detectar e impedir trapaça do que em um MMOG com a simulação completamente descentralizada, onde o computador de cada jogador decide em parte o que irá acontecer como resultado das ações no jogo. No entanto, mesmo em uma rede colaborativa como a que se tem em mente nesta proposta, não há garantias de que alguns dos integrantes não irão tentar subverter as regras do jogos, obtendo vantagens de forma injusta. Porém, imagina-se um sistema de reputação. Ao ingressar no sistema servidor, cada participante terá um registro, armazenado em algum local confiável, de como tem realizado a simulação do jogo.
%
%A princípio, seria designada ao novo servidor uma porção do mundo que seja considerada de importância mínima, de tal modo que tentativas de subversão por parte dele causarão um dano muito pequeno ao jogo, se causarem. Tanto jogadores, quanto outros nodos servidores, poderão reportar casos como esse, de forma a punir ou banir o nodo que agiu de maneira maliciosa. Integrantes honestos do sistema servidor irão ganhando pontos de reputação com o passar do tempo, podendo administrar porções e regiões do mundo do jogo cada vez mais importantes. Acredita-se que seja desmotivadora o suficiente a idéia de destruir a reputação conseguida após um longo tempo de colaboração para o jogo por causa de uma tentativa de trapaça.
%
%Dessa maneira, diversos MMOGs poderiam surgir e se popularizar com mais facilidade, abrindo campo para empresas pequenas e grupos independentes de desenvolvimento de jogos. A cada jogo estaria associada uma comunidade, que se auto-regularia. O nível de justiça ou trapaça em cada um deles iria depender de quem fossem os responsáveis. Comunidades bem organizadas poderiam fazer com que um jogo fosse tão justo quanto um administrado por provedores com contratos comerciais assinados, por exemplo.
